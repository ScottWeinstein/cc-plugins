name: Release

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.2.0, 1.0.0-beta.1)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip push and release creation)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "::error::Invalid version format: $VERSION"
            echo "Version must follow semver (e.g., 0.2.0, 1.0.0-beta.1)"
            exit 1
          fi
          echo "Version $VERSION is valid"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Need full history for tagging
          fetch-depth: 0
          # Use a token that can push (GITHUB_TOKEN works if repo allows)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if tag already exists
        run: |
          TAG_NAME="v${{ inputs.version }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "::error::Tag $TAG_NAME already exists"
            exit 1
          fi
          echo "Tag $TAG_NAME does not exist, proceeding"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run checks
        run: |
          pnpm format:check
          pnpm lint
          pnpm typecheck

      - name: Run tests
        run: pnpm test

      - name: Build
        run: pnpm build

      - name: Update version in package.json files
        run: |
          VERSION="${{ inputs.version }}"

          # Update root package.json
          jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp
          mv package.json.tmp package.json

          # Update plugin package.json files
          for pkg in plugins/*/package.json; do
            jq --arg v "$VERSION" '.version = $v' "$pkg" > "$pkg.tmp"
            mv "$pkg.tmp" "$pkg"
          done

          echo "Updated versions to $VERSION"
          git diff --stat

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version bump
        run: |
          VERSION="${{ inputs.version }}"
          TAG_NAME="v$VERSION"

          git add package.json plugins/*/package.json
          git commit -m "chore: release $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"

          echo "Created commit and tag $TAG_NAME"
          git log -1 --oneline
          git tag -l "$TAG_NAME"

      - name: Push changes
        if: ${{ !inputs.dry_run }}
        run: |
          TAG_NAME="v${{ inputs.version }}"
          git push origin main
          git push origin "$TAG_NAME"
          echo "Pushed main branch and tag $TAG_NAME"

      - name: Pack wt-dev
        run: |
          cd plugins/wt-dev
          pnpm pack
          mv wt-dev-*.tgz ../../wt-dev.tgz

      - name: Create Release
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Release v${{ inputs.version }}
          draft: false
          prerelease: ${{ contains(inputs.version, '-') }}
          generate_release_notes: true
          files: |
            wt-dev.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "## Dry Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Would have released version: **v${{ inputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git diff HEAD~1 --stat >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
